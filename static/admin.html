<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µê³µê¸°ë¬¼ íŒŒì† ì‹ ê³  ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/python-visualization/folium@main/folium/templates/leaflet_heat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        .reports-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reports-table th,
        .reports-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .reports-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            color: #666;
        }

        .reports-table td {
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-received { background: #d4edda; color: #155724; }
        .status-reviewing { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #e2e3e5; color: #383d41; }

        .urgency-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .urgency-1 { background: #e9ecef; color: #6c757d; }
        .urgency-2 { background: #d4edda; color: #155724; }
        .urgency-3 { background: #fff3cd; color: #856404; }
        .urgency-4 { background: #f8d7da; color: #721c24; }
        .urgency-5 { background: #d1ecf1; color: #0c5460; }

        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }

        .cluster-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .cluster-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .cluster-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .emergency-alert {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        /* ì§€ë„ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .map-container {
            height: 500px;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 220px;
            background-color: white;
            border: 2px solid grey;
            z-index: 1000;
            font-size: 14px;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        .map-legend h4 {
            margin-top: 0;
            text-align: center;
        }

        .map-legend p {
            margin: 5px 0;
        }

        .map-legend hr {
            margin: 10px 0;
        }

        .map-legend .legend-stats {
            margin: 5px 0;
            font-size: 12px;
        }

        /* ì‹ ê³  ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detail-section h3 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 16px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: bold;
            width: 120px;
            color: #666;
        }

        .detail-value {
            flex: 1;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .no-image {
            padding: 40px;
            text-align: center;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .map-container {
                height: 400px;
            }
            
            .map-legend {
                width: 180px;
                font-size: 12px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ ê³µê³µê¸°ë¬¼ íŒŒì† ì‹ ê³  ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ì‹¤ì‹œê°„ ì‹ ê³  í˜„í™© ë° ì²˜ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§</p>
    </div>

    <div class="container">
        <button class="refresh-btn" onclick="refreshDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3 id="totalReports">-</h3>
                <p>ì „ì²´ ì‹ ê³ </p>
            </div>
            <div class="stat-card">
                <h3 id="recentReports">-</h3>
                <p>ìµœê·¼ 24ì‹œê°„</p>
            </div>
            <div class="stat-card">
                <h3 id="emergencyReports">-</h3>
                <p>ê¸´ê¸‰ ì‹ ê³ </p>
            </div>
            <div class="stat-card">
                <h3 id="clusterReports">-</h3>
                <p>êµ°ì§‘ ì‹ ê³ </p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">ğŸ“‹ ìµœê·¼ ì‹ ê³  í˜„í™©</div>
                <div class="card-body">
                    <div id="reportsTable">
                        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">ğŸ“Š ì‹ ê³  í†µê³„</div>
                <div class="card-body">
                    <div id="statisticsChart">
                        <div class="loading">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="card-header">ğŸ” êµ°ì§‘ ì‹ ê³  í˜„í™©</div>
            <div class="card-body">
                <div id="clusterInfo">
                    <div class="loading">êµ°ì§‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ìœ„í—˜ë„ ì§€ë„ ì„¹ì…˜ -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">ğŸ—ºï¸ íŒŒì£¼ì‹œ ìœ„í—˜ë„ ì§€ë„</div>
            <div class="card-body" style="position: relative;">
                <div id="riskMap" class="map-container"></div>
                <div class="map-legend">
                    <h4>ğŸ“Š ìœ„í—˜ë„ ë²”ë¡€</h4>
                    <p><span style="color:#DC143C;">â¬¤</span> Level 5 - ê¸´ê¸‰</p>
                    <p><span style="color:#FF6347;">â¬¤</span> Level 4 - ê²½ê³ </p>
                    <p><span style="color:#FFA500;">â¬¤</span> Level 3 - ì£¼ì˜</p>
                    <p><span style="color:#FFFF99;">â¬¤</span> Level 2 - ë³´í†µ</p>
                    <p><span style="color:#90EE90;">â¬¤</span> Level 1 - ë‚®ìŒ</p>
                    <p><span style="color:#808080;">â¬¤</span> ë‹¨ë… ì‹ ê³ </p>
                    <hr>
                    <div class="legend-stats">
                        <b>ì´ ì‹ ê³ :</b> <span id="mapTotalReports">-</span>ê±´<br>
                        <b>êµ°ì§‘:</b> <span id="mapClusterCount">-</span>ê°œ<br>
                        <b>ë‹¨ë…:</b> <span id="mapIndividualCount">-</span>ê±´
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‹ ê³  ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ ì‹ ê³  ìƒì„¸ ì •ë³´</h2>
                <button class="close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body" id="reportModalBody">
                <div class="loading">ì‹ ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        class Dashboard {
            constructor() {
                this.refreshInterval = null;
                this.map = null;
                this.init();
            }

            init() {
                this.loadDashboard();
                this.initMap();
                // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
                this.refreshInterval = setInterval(() => {
                    this.loadDashboard();
                }, 30000);
            }

            async loadDashboard() {
                try {
                    await Promise.all([
                        this.loadStatistics(),
                        this.loadRecentReports(),
                        this.loadClusterInfo(),
                        this.loadMapData()
                    ]);
                } catch (error) {
                    console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            async loadStatistics() {
                try {
                    const response = await fetch('/api/statistics');
                    const stats = await response.json();
                    
                    document.getElementById('totalReports').textContent = stats.total_reports;
                    document.getElementById('recentReports').textContent = stats.recent_24h;
                    
                    // ê¸´ê¸‰ ì‹ ê³  ìˆ˜ ê³„ì‚° (ê¸´ê¸‰ë„ 4, 5)
                    const emergencyCount = (stats.urgency_distribution[4] || 0) + (stats.urgency_distribution[5] || 0);
                    document.getElementById('emergencyReports').textContent = emergencyCount;
                    
                    // í†µê³„ ì°¨íŠ¸ ìƒì„±
                    this.createStatisticsChart(stats);
                } catch (error) {
                    console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            async loadRecentReports() {
                try {
                    const response = await fetch('/api/reports');
                    const reports = await response.json();
                    
                    this.createReportsTable(reports);
                } catch (error) {
                    console.error('ì‹ ê³  ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            async loadClusterInfo() {
                try {
                    const response = await fetch('/api/clusters');
                    const clusterData = await response.json();
                    
                    document.getElementById('clusterReports').textContent = clusterData.cluster_count || 0;
                    this.createClusterInfo(clusterData.clusters);
                } catch (error) {
                    console.error('êµ°ì§‘ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            createStatisticsChart(stats) {
                const chartContainer = document.getElementById('statisticsChart');
                
                let chartHtml = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
                
                // ê¸´ê¸‰ë„ë³„ ë¶„í¬
                chartHtml += '<div>';
                chartHtml += '<h4 style="margin-bottom: 15px; color: #667eea;">ê¸´ê¸‰ë„ë³„ ë¶„í¬</h4>';
                const urgencyLabels = ['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ', 'ë§¤ìš°ë†’ìŒ', 'ê¸´ê¸‰'];
                for (let i = 1; i <= 5; i++) {
                    const count = stats.urgency_distribution[i] || 0;
                    const percentage = stats.total_reports > 0 ? (count / stats.total_reports * 100).toFixed(1) : 0;
                    chartHtml += `<div style="margin: 8px 0; display: flex; justify-content: space-between;">`;
                    chartHtml += `<span>${urgencyLabels[i-1]}</span>`;
                    chartHtml += `<span><span class="urgency-badge urgency-${i}">${count}</span> (${percentage}%)</span>`;
                    chartHtml += `</div>`;
                }
                chartHtml += '</div>';
                
                // ì†ìƒ ìœ í˜•ë³„ ë¶„í¬
                chartHtml += '<div>';
                chartHtml += '<h4 style="margin-bottom: 15px; color: #667eea;">ì†ìƒ ìœ í˜•ë³„ ë¶„í¬</h4>';
                for (const [damageType, count] of Object.entries(stats.damage_type_distribution)) {
                    const percentage = stats.total_reports > 0 ? (count / stats.total_reports * 100).toFixed(1) : 0;
                    chartHtml += `<div style="margin: 8px 0; display: flex; justify-content: space-between;">`;
                    chartHtml += `<span>${damageType}</span>`;
                    chartHtml += `<span>${count} (${percentage}%)</span>`;
                    chartHtml += `</div>`;
                }
                chartHtml += '</div>';
                
                chartHtml += '</div>';
                chartContainer.innerHTML = chartHtml;
            }

            createReportsTable(reports) {
                const tableContainer = document.getElementById('reportsTable');
                
                if (!reports || reports.length === 0) {
                    tableContainer.innerHTML = '<div class="loading">ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                let tableHtml = '<table class="reports-table">';
                tableHtml += '<thead><tr>';
                tableHtml += '<th>ì‹ ê³ ë²ˆí˜¸</th><th>ì†ìƒìœ í˜•</th><th>ê¸´ê¸‰ë„</th><th>ìƒíƒœ</th><th>ì‹ ê³ ì‹œê°„</th><th>ê´€ë¦¬</th>';
                tableHtml += '</tr></thead><tbody>';
                
                reports.slice(0, 10).forEach(report => {
                    const urgencyText = ['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ', 'ë§¤ìš°ë†’ìŒ', 'ê¸´ê¸‰'][report.urgency_level - 1];
                    const statusText = {
                        'ì ‘ìˆ˜': 'ì ‘ìˆ˜ì™„ë£Œ',
                        'ê²€í† ì¤‘': 'ê²€í† ì¤‘',
                        'ì²˜ë¦¬ì¤‘': 'ì²˜ë¦¬ì¤‘',
                        'ì™„ë£Œ': 'ì²˜ë¦¬ì™„ë£Œ'
                    }[report.status] || report.status;
                    
                    tableHtml += '<tr>';
                    tableHtml += `<td>#${report.id}</td>`;
                    tableHtml += `<td>${report.damage_type}</td>`;
                    tableHtml += `<td><span class="urgency-badge urgency-${report.urgency_level}">${urgencyText}</span></td>`;
                    tableHtml += `<td><span class="status-badge status-${report.status.toLowerCase()}">${statusText}</span></td>`;
                    tableHtml += `<td>${new Date(report.created_at).toLocaleString()}</td>`;
                    tableHtml += `<td><button class="btn btn-primary" onclick="showReportDetail(${report.id})" style="padding: 5px 10px; font-size: 12px;">ìƒì„¸ë³´ê¸°</button></td>`;
                    tableHtml += '</tr>';
                });
                
                tableHtml += '</tbody></table>';
                tableContainer.innerHTML = tableHtml;
            }

            createClusterInfo(clusters) {
                const clusterContainer = document.getElementById('clusterInfo');
                
                if (!clusters || clusters.length === 0) {
                    clusterContainer.innerHTML = '<div class="loading">êµ°ì§‘ ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                let clusterHtml = '';
                clusters.forEach(cluster => {
                    clusterHtml += '<div class="cluster-info">';
                    clusterHtml += `<h4>êµ°ì§‘ ${cluster.cluster_id} (${cluster.report_count}ê±´)</h4>`;
                    clusterHtml += `<p><strong>ìœ„ì¹˜:</strong> ìœ„ë„ ${cluster.center_latitude.toFixed(6)}, ê²½ë„ ${cluster.center_longitude.toFixed(6)}</p>`;
                    clusterHtml += `<p><strong>ìµœê³  ê¸´ê¸‰ë„:</strong> <span class="urgency-badge urgency-${cluster.max_urgency}">${['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ', 'ë§¤ìš°ë†’ìŒ', 'ê¸´ê¸‰'][cluster.max_urgency - 1]}</span></p>`;
                    
                    if (cluster.max_urgency >= 4) {
                        clusterHtml += '<div class="emergency-alert">âš ï¸ ê¸´ê¸‰ ì²˜ë¦¬ê°€ í•„ìš”í•œ êµ°ì§‘ì…ë‹ˆë‹¤!</div>';
                    }
                    
                    clusterHtml += '</div>';
                });
                
                clusterContainer.innerHTML = clusterHtml;
            }

            initMap() {
                // íŒŒì£¼ì‹œ ì¤‘ì‹¬ ì¢Œí‘œ
                this.map = L.map('riskMap', {
                    center: [37.7598688, 126.7801781],
                    zoom: 13,
                    zoomControl: true
                });

                // OpenStreetMap íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(this.map);
            }

            async loadMapData() {
                try {
                    const response = await fetch('/api/reports');
                    const reports = await response.json();
                    
                    if (this.map) {
                        this.updateMap(reports);
                    }
                } catch (error) {
                    console.error('ì§€ë„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            updateMap(reports) {
                // ê¸°ì¡´ ë§ˆì»¤ì™€ ë ˆì´ì–´ ì œê±°
                this.map.eachLayer(layer => {
                    if (layer !== this.map._layers[Object.keys(this.map._layers)[0]]) {
                        this.map.removeLayer(layer);
                    }
                });

                if (!reports || reports.length === 0) return;

                let clusterData = {};
                let individualCount = 0;
                let clusterCount = 0;

                // ì‹ ê³  ë°ì´í„° ì²˜ë¦¬
                reports.forEach(report => {
                    const lat = report.latitude;
                    const lon = report.longitude;
                    const urgency = report.urgency_level;
                    const clusterId = report.cluster_id;

                    if (clusterId && clusterId !== 'ë‹¨ë…') {
                        if (!clusterData[clusterId]) {
                            clusterData[clusterId] = {
                                reports: [],
                                centerLat: 0,
                                centerLon: 0,
                                maxUrgency: 0
                            };
                        }
                        clusterData[clusterId].reports.push(report);
                        clusterData[clusterId].centerLat += lat;
                        clusterData[clusterId].centerLon += lon;
                        clusterData[clusterId].maxUrgency = Math.max(clusterData[clusterId].maxUrgency, urgency);
                    } else {
                        individualCount++;
                        this.addIndividualMarker(lat, lon, report);
                    }
                });

                // êµ°ì§‘ ì²˜ë¦¬
                Object.keys(clusterData).forEach(clusterId => {
                    const cluster = clusterData[clusterId];
                    cluster.centerLat /= cluster.reports.length;
                    cluster.centerLon /= cluster.reports.length;
                    
                    clusterCount++;
                    this.addClusterMarker(cluster.centerLat, cluster.centerLon, cluster, clusterId);
                    
                    // êµ°ì§‘ ë‚´ ê°œë³„ ì‹ ê³  ë§ˆì»¤ ì¶”ê°€
                    cluster.reports.forEach(report => {
                        this.addIndividualMarker(report.latitude, report.longitude, report, true);
                    });
                });

                // íˆíŠ¸ë§µ ë°ì´í„° ìƒì„±
                const heatData = reports.map(report => [
                    report.latitude, 
                    report.longitude, 
                    report.urgency_level
                ]);

                // íˆíŠ¸ë§µ ë ˆì´ì–´ ì¶”ê°€
                if (heatData.length > 0) {
                    L.heatLayer(heatData, {
                        minOpacity: 0.3,
                        maxZoom: 18,
                        radius: 25,
                        blur: 20,
                        gradient: {
                            0.4: "blue",
                            0.6: "yellow", 
                            0.8: "orange",
                            1.0: "red"
                        },
                        maxOpacity: 0.8
                    }).addTo(this.map);
                }

                // ë²”ë¡€ ì—…ë°ì´íŠ¸
                document.getElementById('mapTotalReports').textContent = reports.length;
                document.getElementById('mapClusterCount').textContent = clusterCount;
                document.getElementById('mapIndividualCount').textContent = individualCount;
            }

            addIndividualMarker(lat, lon, report, isInCluster = false) {
                const urgency = report.urgency_level;
                let markerColor, iconType;

                if (isInCluster) {
                    // êµ°ì§‘ ë‚´ ì‹ ê³ ëŠ” ì‘ì€ ì›í˜• ë§ˆì»¤
                    markerColor = urgency >= 4 ? 'red' : urgency >= 3 ? 'orange' : 'blue';
                    iconType = 'record';
                } else {
                    // ë‹¨ë… ì‹ ê³ ëŠ” ë‹¤ë¥¸ ì•„ì´ì½˜
                    markerColor = urgency >= 4 ? 'red' : urgency >= 3 ? 'orange' : 'blue';
                    iconType = urgency >= 4 ? 'fire' : urgency >= 3 ? 'exclamation-sign' : 'warning-sign';
                }

                const icon = L.AwesomeMarkers.icon({
                    markerColor: markerColor,
                    iconColor: 'white',
                    icon: iconType,
                    prefix: 'glyphicon',
                    extraClasses: 'fa-rotate-0'
                });

                const marker = L.marker([lat, lon], { icon: icon }).addTo(this.map);

                const popupContent = `
                    <div style="font-family: Arial; width: 200px;">
                        <h4 style="margin: 0; color: ${urgency >= 4 ? '#FF6347' : urgency >= 3 ? '#FFA500' : '#808080'};">
                            ğŸš¨ ì‹ ê³  ID: ${report.id}
                        </h4>
                        <hr style="margin: 5px 0;">
                        <b>ìœ„í—˜ë„:</b> ${isInCluster ? `Level ${urgency}` : `ë‹¨ë… (ê¸´ê¸‰ë„ ${urgency})`}<br>
                        <b>ìœ„í—˜ë„ ì ìˆ˜:</b> ${report.risk_score || urgency}<br>
                        <b>ê¸´ê¸‰ë„:</b> ${urgency}<br>
                        <b>êµ°ì§‘ ID:</b> ${report.cluster_id || 'ë‹¨ë…'}<br>
                        <b>ì‹œê°„:</b> ${new Date(report.created_at).toLocaleString()}<br>
                        <b>ìœ„ì¹˜:</b> (${lat.toFixed(5)}, ${lon.toFixed(5)})
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.bindTooltip(`ì‹ ê³  ${report.id} - ${isInCluster ? `Level ${urgency}` : `ë‹¨ë… (ê¸´ê¸‰ë„ ${urgency})`}`);
            }

            addClusterMarker(lat, lon, cluster, clusterId) {
                const urgency = cluster.maxUrgency;
                let color;

                if (urgency >= 4) color = '#FF6347';
                else if (urgency >= 3) color = '#FFA500';
                else color = '#FFFF99';

                // êµ°ì§‘ ì›í˜• ì˜ì—­
                const circle = L.circle([lat, lon], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.3,
                    radius: 500,
                    weight: 3
                }).addTo(this.map);

                circle.bindPopup(`êµ°ì§‘ ${clusterId}<br>ìœ„í—˜ë„: Level ${urgency}<br>ì‹ ê³ : ${cluster.reports.length}ê±´`);
                circle.bindTooltip(`êµ°ì§‘ ${clusterId} - ${cluster.reports.length}ê±´`);

                // êµ°ì§‘ ì¤‘ì‹¬ ë§ˆì»¤
                const clusterIcon = L.divIcon({
                    html: `
                        <div style="
                            font-size: 16px; 
                            font-weight: bold; 
                            color: white; 
                            background-color: ${color}; 
                            border: 3px solid white;
                            border-radius: 50%; 
                            width: 40px; 
                            height: 40px; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                            box-shadow: 0 0 10px rgba(0,0,0,0.5);
                        ">
                            ${cluster.reports.length}
                        </div>
                    `,
                    className: 'empty'
                });

                L.marker([lat, lon], { icon: clusterIcon }).addTo(this.map);
            }
        }

        function refreshDashboard() {
            if (window.dashboard) {
                window.dashboard.loadDashboard();
            }
        }

        // ì‹ ê³  ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function showReportDetail(reportId) {
            const modal = document.getElementById('reportModal');
            const modalBody = document.getElementById('reportModalBody');
            
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading">ì‹ ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const response = await fetch(`/api/report/${reportId}/detail`);
                const report = await response.json();
                
                displayReportDetail(report);
            } catch (error) {
                console.error('ì‹ ê³  ìƒì„¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                modalBody.innerHTML = '<div class="loading">ì‹ ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        function displayReportDetail(report) {
            const modalBody = document.getElementById('reportModalBody');
            
            const urgencyText = ['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ', 'ë§¤ìš°ë†’ìŒ', 'ê¸´ê¸‰'][report.urgency_level - 1];
            const statusText = {
                'ì ‘ìˆ˜': 'ì ‘ìˆ˜ì™„ë£Œ',
                'ê²€í† ì¤‘': 'ê²€í† ì¤‘',
                'ì²˜ë¦¬ì¤‘': 'ì²˜ë¦¬ì¤‘',
                'ì™„ë£Œ': 'ì²˜ë¦¬ì™„ë£Œ'
            }[report.status] || report.status;
            
            let html = '';
            
            // ê¸°ë³¸ ì •ë³´ ì„¹ì…˜
            html += '<div class="detail-section">';
            html += '<h3>ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>';
            html += '<div class="detail-row"><span class="detail-label">ì‹ ê³ ë²ˆí˜¸:</span><span class="detail-value">#' + report.id + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">ì‚¬ìš©ìID:</span><span class="detail-value">' + report.user_id + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">ì†ìƒìœ í˜•:</span><span class="detail-value">' + report.damage_type + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">ê¸´ê¸‰ë„:</span><span class="detail-value"><span class="urgency-badge urgency-' + report.urgency_level + '">' + urgencyText + '</span></span></div>';
            html += '<div class="detail-row"><span class="detail-label">ìƒíƒœ:</span><span class="detail-value"><span class="status-badge status-' + report.status.toLowerCase() + '">' + statusText + '</span></span></div>';
            html += '<div class="detail-row"><span class="detail-label">ì ‘ìˆ˜ì¼:</span><span class="detail-value">' + new Date(report.created_at).toLocaleString('ko-KR') + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">ìˆ˜ì •ì¼:</span><span class="detail-value">' + new Date(report.updated_at).toLocaleString('ko-KR') + '</span></div>';
            html += '</div>';
            
            // ìœ„ì¹˜ ì •ë³´ ì„¹ì…˜
            if (report.location || (report.latitude && report.longitude)) {
                html += '<div class="detail-section">';
                html += '<h3>ğŸ“ ìœ„ì¹˜ ì •ë³´</h3>';
                if (report.location) {
                    html += '<div class="detail-row"><span class="detail-label">ì£¼ì†Œ:</span><span class="detail-value">' + report.location + '</span></div>';
                }
                if (report.latitude && report.longitude) {
                    html += '<div class="detail-row"><span class="detail-label">ì¢Œí‘œ:</span><span class="detail-value">ìœ„ë„ ' + report.latitude.toFixed(6) + ', ê²½ë„ ' + report.longitude.toFixed(6) + '</span></div>';
                }
                html += '</div>';
            }
            
            // ë‹´ë‹¹ ë¶€ì„œ ì •ë³´ ì„¹ì…˜
            html += '<div class="detail-section">';
            html += '<h3>ğŸ¢ ë‹´ë‹¹ ë¶€ì„œ</h3>';
            html += '<div class="detail-row"><span class="detail-label">ë¶€ì„œëª…:</span><span class="detail-value">' + report.department + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">ì—°ë½ì²˜:</span><span class="detail-value">' + report.department_contact + '</span></div>';
            html += '</div>';
            
            // ì„¤ëª… ì„¹ì…˜
            if (report.description) {
                html += '<div class="detail-section">';
                html += '<h3>ğŸ“ ìƒì„¸ ì„¤ëª…</h3>';
                html += '<div class="detail-value">' + report.description + '</div>';
                html += '</div>';
            }
            
            // ì´ë¯¸ì§€ ì„¹ì…˜
            if (report.image_path) {
                html += '<div class="detail-section">';
                html += '<h3>ğŸ“¸ ì²¨ë¶€ ì´ë¯¸ì§€</h3>';
                html += '<img src="/uploads/' + report.image_path + '" alt="ì‹ ê³  ì´ë¯¸ì§€" class="image-preview">';
                html += '<div class="no-image" style="display:none;">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                html += '</div>';
            }
            
            // ì•¡ì…˜ ë²„íŠ¼ë“¤
            html += '<div class="action-buttons">';
            
            // ìƒíƒœ ë³€ê²½ ë²„íŠ¼ë“¤
            const statusButtons = {
                'ì ‘ìˆ˜': ['ê²€í† ì¤‘', 'ì™„ë£Œ'],
                'ê²€í† ì¤‘': ['ì²˜ë¦¬ì¤‘', 'ì™„ë£Œ'],
                'ì²˜ë¦¬ì¤‘': ['ì™„ë£Œ'],
                'ì™„ë£Œ': []
            };
            
            const availableStatuses = statusButtons[report.status] || [];
            availableStatuses.forEach(status => {
                const buttonClass = status === 'ì™„ë£Œ' ? 'btn-success' : 
                                  status === 'ì²˜ë¦¬ì¤‘' ? 'btn-warning' : 'btn-primary';
                html += '<button class="btn ' + buttonClass + '" data-action="update" data-report-id="' + report.id + '" data-status="' + status + '">' + status + 'ë¡œ ë³€ê²½</button>';
            });
            
            html += '<button class="btn btn-danger" data-action="delete" data-report-id="' + report.id + '">ì‹ ê³  ì‚­ì œ</button>';
            html += '<button class="btn btn-secondary" data-action="close">ë‹«ê¸°</button>';
            html += '</div>';
            
            modalBody.innerHTML = html;
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            modalBody.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn')) {
                    const action = e.target.getAttribute('data-action');
                    const reportId = e.target.getAttribute('data-report-id');
                    const status = e.target.getAttribute('data-status');
                    
                    if (action === 'update') {
                        updateReportStatus(reportId, status);
                    } else if (action === 'delete') {
                        deleteReport(reportId);
                    } else if (action === 'close') {
                        closeReportModal();
                    }
                }
            });
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        async function updateReportStatus(reportId, newStatus) {
            if (!confirm('ì‹ ê³  #' + reportId + 'ì˜ ìƒíƒœë¥¼ \'' + newStatus + '\'ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/report/' + reportId + '/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newStatus)
                });
                
                if (response.ok) {
                    alert('ì‹ ê³  ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeReportModal();
                    refreshDashboard(); // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                } else {
                    const error = await response.json();
                    alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error.detail);
                }
            } catch (error) {
                console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('ì‹ ê³  #' + reportId + 'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/report/' + reportId, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('ì‹ ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeReportModal();
                    refreshDashboard(); // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                } else {
                    const error = await response.json();
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.detail);
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target === modal) {
                closeReportModal();
            }
        }

        // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
        window.dashboard = new Dashboard();
    </script>
</body>
</html>
