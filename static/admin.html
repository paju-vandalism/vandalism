<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공공기물 파손 신고 관리 대시보드</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/python-visualization/folium@main/folium/templates/leaflet_heat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        .reports-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reports-table th,
        .reports-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .reports-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            color: #666;
        }

        .reports-table td {
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-received { background: #d4edda; color: #155724; }
        .status-reviewing { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #e2e3e5; color: #383d41; }

        .urgency-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .urgency-1 { background: #e9ecef; color: #6c757d; }
        .urgency-2 { background: #d4edda; color: #155724; }
        .urgency-3 { background: #fff3cd; color: #856404; }
        .urgency-4 { background: #f8d7da; color: #721c24; }
        .urgency-5 { background: #d1ecf1; color: #0c5460; }

        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }

        .cluster-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .cluster-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .cluster-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .emergency-alert {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        /* 지도 관련 스타일 */
        .map-container {
            height: 500px;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 220px;
            background-color: white;
            border: 2px solid grey;
            z-index: 1000;
            font-size: 14px;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        .map-legend h4 {
            margin-top: 0;
            text-align: center;
        }

        .map-legend p {
            margin: 5px 0;
        }

        .map-legend hr {
            margin: 10px 0;
        }

        .map-legend .legend-stats {
            margin: 5px 0;
            font-size: 12px;
        }

        /* 신고 상세보기 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detail-section h3 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 16px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: bold;
            width: 120px;
            color: #666;
        }

        .detail-value {
            flex: 1;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .no-image {
            padding: 40px;
            text-align: center;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .map-container {
                height: 400px;
            }
            
            .map-legend {
                width: 180px;
                font-size: 12px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🏛️ 공공기물 파손 신고 관리 대시보드</h1>
        <p>실시간 신고 현황 및 처리 상태 모니터링</p>
    </div>

    <div class="container">
        <button class="refresh-btn" onclick="refreshDashboard()">🔄 새로고침</button>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3 id="totalReports">-</h3>
                <p>전체 신고</p>
            </div>
            <div class="stat-card">
                <h3 id="recentReports">-</h3>
                <p>최근 24시간</p>
            </div>
            <div class="stat-card">
                <h3 id="emergencyReports">-</h3>
                <p>긴급 신고</p>
            </div>
            <div class="stat-card">
                <h3 id="clusterReports">-</h3>
                <p>군집 신고</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">📋 최근 신고 현황</div>
                <div class="card-body">
                    <div id="reportsTable">
                        <div class="loading">데이터를 불러오는 중...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">📊 신고 통계</div>
                <div class="card-body">
                    <div id="statisticsChart">
                        <div class="loading">통계를 불러오는 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="card-header">🔍 군집 신고 현황</div>
            <div class="card-body">
                <div id="clusterInfo">
                    <div class="loading">군집 정보를 불러오는 중...</div>
                </div>
            </div>
        </div>

        <!-- 위험도 지도 섹션 -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">🗺️ 파주시 위험도 지도</div>
            <div class="card-body" style="position: relative;">
                <div id="riskMap" class="map-container"></div>
                <div class="map-legend">
                    <h4>📊 위험도 범례</h4>
                    <p><span style="color:#DC143C;">⬤</span> Level 5 - 긴급</p>
                    <p><span style="color:#FF6347;">⬤</span> Level 4 - 경고</p>
                    <p><span style="color:#FFA500;">⬤</span> Level 3 - 주의</p>
                    <p><span style="color:#FFFF99;">⬤</span> Level 2 - 보통</p>
                    <p><span style="color:#90EE90;">⬤</span> Level 1 - 낮음</p>
                    <p><span style="color:#808080;">⬤</span> 단독 신고</p>
                    <hr>
                    <div class="legend-stats">
                        <b>총 신고:</b> <span id="mapTotalReports">-</span>건<br>
                        <b>군집:</b> <span id="mapClusterCount">-</span>개<br>
                        <b>단독:</b> <span id="mapIndividualCount">-</span>건
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 신고 상세보기 모달 -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 신고 상세 정보</h2>
                <button class="close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body" id="reportModalBody">
                <div class="loading">신고 정보를 불러오는 중...</div>
            </div>
        </div>
    </div>

    <script>
        class Dashboard {
            constructor() {
                this.refreshInterval = null;
                this.map = null;
                this.init();
            }

            init() {
                this.loadDashboard();
                this.initMap();
                // 30초마다 자동 새로고침
                this.refreshInterval = setInterval(() => {
                    this.loadDashboard();
                }, 30000);
            }

            async loadDashboard() {
                try {
                    await Promise.all([
                        this.loadStatistics(),
                        this.loadRecentReports(),
                        this.loadClusterInfo(),
                        this.loadMapData()
                    ]);
                } catch (error) {
                    console.error('대시보드 로드 오류:', error);
                }
            }

            async loadStatistics() {
                try {
                    const response = await fetch('/api/statistics');
                    const stats = await response.json();
                    
                    document.getElementById('totalReports').textContent = stats.total_reports;
                    document.getElementById('recentReports').textContent = stats.recent_24h;
                    
                    // 긴급 신고 수 계산 (긴급도 4, 5)
                    const emergencyCount = (stats.urgency_distribution[4] || 0) + (stats.urgency_distribution[5] || 0);
                    document.getElementById('emergencyReports').textContent = emergencyCount;
                    
                    // 통계 차트 생성
                    this.createStatisticsChart(stats);
                } catch (error) {
                    console.error('통계 로드 오류:', error);
                }
            }

            async loadRecentReports() {
                try {
                    const response = await fetch('/api/reports');
                    const reports = await response.json();
                    
                    this.createReportsTable(reports);
                } catch (error) {
                    console.error('신고 목록 로드 오류:', error);
                }
            }

            async loadClusterInfo() {
                try {
                    const response = await fetch('/api/clusters');
                    const clusterData = await response.json();
                    
                    document.getElementById('clusterReports').textContent = clusterData.cluster_count || 0;
                    this.createClusterInfo(clusterData.clusters);
                } catch (error) {
                    console.error('군집 정보 로드 오류:', error);
                }
            }

            createStatisticsChart(stats) {
                const chartContainer = document.getElementById('statisticsChart');
                
                let chartHtml = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
                
                // 긴급도별 분포
                chartHtml += '<div>';
                chartHtml += '<h4 style="margin-bottom: 15px; color: #667eea;">긴급도별 분포</h4>';
                const urgencyLabels = ['낮음', '보통', '높음', '매우높음', '긴급'];
                for (let i = 1; i <= 5; i++) {
                    const count = stats.urgency_distribution[i] || 0;
                    const percentage = stats.total_reports > 0 ? (count / stats.total_reports * 100).toFixed(1) : 0;
                    chartHtml += `<div style="margin: 8px 0; display: flex; justify-content: space-between;">`;
                    chartHtml += `<span>${urgencyLabels[i-1]}</span>`;
                    chartHtml += `<span><span class="urgency-badge urgency-${i}">${count}</span> (${percentage}%)</span>`;
                    chartHtml += `</div>`;
                }
                chartHtml += '</div>';
                
                // 손상 유형별 분포
                chartHtml += '<div>';
                chartHtml += '<h4 style="margin-bottom: 15px; color: #667eea;">손상 유형별 분포</h4>';
                for (const [damageType, count] of Object.entries(stats.damage_type_distribution)) {
                    const percentage = stats.total_reports > 0 ? (count / stats.total_reports * 100).toFixed(1) : 0;
                    chartHtml += `<div style="margin: 8px 0; display: flex; justify-content: space-between;">`;
                    chartHtml += `<span>${damageType}</span>`;
                    chartHtml += `<span>${count} (${percentage}%)</span>`;
                    chartHtml += `</div>`;
                }
                chartHtml += '</div>';
                
                chartHtml += '</div>';
                chartContainer.innerHTML = chartHtml;
            }

            createReportsTable(reports) {
                const tableContainer = document.getElementById('reportsTable');
                
                if (!reports || reports.length === 0) {
                    tableContainer.innerHTML = '<div class="loading">신고가 없습니다.</div>';
                    return;
                }
                
                let tableHtml = '<table class="reports-table">';
                tableHtml += '<thead><tr>';
                tableHtml += '<th>신고번호</th><th>손상유형</th><th>긴급도</th><th>상태</th><th>신고시간</th><th>관리</th>';
                tableHtml += '</tr></thead><tbody>';
                
                reports.slice(0, 10).forEach(report => {
                    const urgencyText = ['낮음', '보통', '높음', '매우높음', '긴급'][report.urgency_level - 1];
                    const statusText = {
                        '접수': '접수완료',
                        '검토중': '검토중',
                        '처리중': '처리중',
                        '완료': '처리완료'
                    }[report.status] || report.status;
                    
                    tableHtml += '<tr>';
                    tableHtml += `<td>#${report.id}</td>`;
                    tableHtml += `<td>${report.damage_type}</td>`;
                    tableHtml += `<td><span class="urgency-badge urgency-${report.urgency_level}">${urgencyText}</span></td>`;
                    tableHtml += `<td><span class="status-badge status-${report.status.toLowerCase()}">${statusText}</span></td>`;
                    tableHtml += `<td>${new Date(report.created_at).toLocaleString()}</td>`;
                    tableHtml += `<td><button class="btn btn-primary" onclick="showReportDetail(${report.id})" style="padding: 5px 10px; font-size: 12px;">상세보기</button></td>`;
                    tableHtml += '</tr>';
                });
                
                tableHtml += '</tbody></table>';
                tableContainer.innerHTML = tableHtml;
            }

            createClusterInfo(clusters) {
                const clusterContainer = document.getElementById('clusterInfo');
                
                if (!clusters || clusters.length === 0) {
                    clusterContainer.innerHTML = '<div class="loading">군집 신고가 없습니다.</div>';
                    return;
                }
                
                let clusterHtml = '';
                clusters.forEach(cluster => {
                    clusterHtml += '<div class="cluster-info">';
                    clusterHtml += `<h4>군집 ${cluster.cluster_id} (${cluster.report_count}건)</h4>`;
                    clusterHtml += `<p><strong>위치:</strong> 위도 ${cluster.center_latitude.toFixed(6)}, 경도 ${cluster.center_longitude.toFixed(6)}</p>`;
                    clusterHtml += `<p><strong>최고 긴급도:</strong> <span class="urgency-badge urgency-${cluster.max_urgency}">${['낮음', '보통', '높음', '매우높음', '긴급'][cluster.max_urgency - 1]}</span></p>`;
                    
                    if (cluster.max_urgency >= 4) {
                        clusterHtml += '<div class="emergency-alert">⚠️ 긴급 처리가 필요한 군집입니다!</div>';
                    }
                    
                    clusterHtml += '</div>';
                });
                
                clusterContainer.innerHTML = clusterHtml;
            }

            initMap() {
                // 파주시 중심 좌표
                this.map = L.map('riskMap', {
                    center: [37.7598688, 126.7801781],
                    zoom: 13,
                    zoomControl: true
                });

                // OpenStreetMap 타일 레이어 추가
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(this.map);
            }

            async loadMapData() {
                try {
                    const response = await fetch('/api/reports');
                    const reports = await response.json();
                    
                    if (this.map) {
                        this.updateMap(reports);
                    }
                } catch (error) {
                    console.error('지도 데이터 로드 오류:', error);
                }
            }

            updateMap(reports) {
                // 기존 마커와 레이어 제거
                this.map.eachLayer(layer => {
                    if (layer !== this.map._layers[Object.keys(this.map._layers)[0]]) {
                        this.map.removeLayer(layer);
                    }
                });

                if (!reports || reports.length === 0) return;

                let clusterData = {};
                let individualCount = 0;
                let clusterCount = 0;

                // 신고 데이터 처리
                reports.forEach(report => {
                    const lat = report.latitude;
                    const lon = report.longitude;
                    const urgency = report.urgency_level;
                    const clusterId = report.cluster_id;

                    if (clusterId && clusterId !== '단독') {
                        if (!clusterData[clusterId]) {
                            clusterData[clusterId] = {
                                reports: [],
                                centerLat: 0,
                                centerLon: 0,
                                maxUrgency: 0
                            };
                        }
                        clusterData[clusterId].reports.push(report);
                        clusterData[clusterId].centerLat += lat;
                        clusterData[clusterId].centerLon += lon;
                        clusterData[clusterId].maxUrgency = Math.max(clusterData[clusterId].maxUrgency, urgency);
                    } else {
                        individualCount++;
                        this.addIndividualMarker(lat, lon, report);
                    }
                });

                // 군집 처리
                Object.keys(clusterData).forEach(clusterId => {
                    const cluster = clusterData[clusterId];
                    cluster.centerLat /= cluster.reports.length;
                    cluster.centerLon /= cluster.reports.length;
                    
                    clusterCount++;
                    this.addClusterMarker(cluster.centerLat, cluster.centerLon, cluster, clusterId);
                    
                    // 군집 내 개별 신고 마커 추가
                    cluster.reports.forEach(report => {
                        this.addIndividualMarker(report.latitude, report.longitude, report, true);
                    });
                });

                // 히트맵 데이터 생성
                const heatData = reports.map(report => [
                    report.latitude, 
                    report.longitude, 
                    report.urgency_level
                ]);

                // 히트맵 레이어 추가
                if (heatData.length > 0) {
                    L.heatLayer(heatData, {
                        minOpacity: 0.3,
                        maxZoom: 18,
                        radius: 25,
                        blur: 20,
                        gradient: {
                            0.4: "blue",
                            0.6: "yellow", 
                            0.8: "orange",
                            1.0: "red"
                        },
                        maxOpacity: 0.8
                    }).addTo(this.map);
                }

                // 범례 업데이트
                document.getElementById('mapTotalReports').textContent = reports.length;
                document.getElementById('mapClusterCount').textContent = clusterCount;
                document.getElementById('mapIndividualCount').textContent = individualCount;
            }

            addIndividualMarker(lat, lon, report, isInCluster = false) {
                const urgency = report.urgency_level;
                let markerColor, iconType;

                if (isInCluster) {
                    // 군집 내 신고는 작은 원형 마커
                    markerColor = urgency >= 4 ? 'red' : urgency >= 3 ? 'orange' : 'blue';
                    iconType = 'record';
                } else {
                    // 단독 신고는 다른 아이콘
                    markerColor = urgency >= 4 ? 'red' : urgency >= 3 ? 'orange' : 'blue';
                    iconType = urgency >= 4 ? 'fire' : urgency >= 3 ? 'exclamation-sign' : 'warning-sign';
                }

                const icon = L.AwesomeMarkers.icon({
                    markerColor: markerColor,
                    iconColor: 'white',
                    icon: iconType,
                    prefix: 'glyphicon',
                    extraClasses: 'fa-rotate-0'
                });

                const marker = L.marker([lat, lon], { icon: icon }).addTo(this.map);

                const popupContent = `
                    <div style="font-family: Arial; width: 200px;">
                        <h4 style="margin: 0; color: ${urgency >= 4 ? '#FF6347' : urgency >= 3 ? '#FFA500' : '#808080'};">
                            🚨 신고 ID: ${report.id}
                        </h4>
                        <hr style="margin: 5px 0;">
                        <b>위험도:</b> ${isInCluster ? `Level ${urgency}` : `단독 (긴급도 ${urgency})`}<br>
                        <b>위험도 점수:</b> ${report.risk_score || urgency}<br>
                        <b>긴급도:</b> ${urgency}<br>
                        <b>군집 ID:</b> ${report.cluster_id || '단독'}<br>
                        <b>시간:</b> ${new Date(report.created_at).toLocaleString()}<br>
                        <b>위치:</b> (${lat.toFixed(5)}, ${lon.toFixed(5)})
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.bindTooltip(`신고 ${report.id} - ${isInCluster ? `Level ${urgency}` : `단독 (긴급도 ${urgency})`}`);
            }

            addClusterMarker(lat, lon, cluster, clusterId) {
                const urgency = cluster.maxUrgency;
                let color;

                if (urgency >= 4) color = '#FF6347';
                else if (urgency >= 3) color = '#FFA500';
                else color = '#FFFF99';

                // 군집 원형 영역
                const circle = L.circle([lat, lon], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.3,
                    radius: 500,
                    weight: 3
                }).addTo(this.map);

                circle.bindPopup(`군집 ${clusterId}<br>위험도: Level ${urgency}<br>신고: ${cluster.reports.length}건`);
                circle.bindTooltip(`군집 ${clusterId} - ${cluster.reports.length}건`);

                // 군집 중심 마커
                const clusterIcon = L.divIcon({
                    html: `
                        <div style="
                            font-size: 16px; 
                            font-weight: bold; 
                            color: white; 
                            background-color: ${color}; 
                            border: 3px solid white;
                            border-radius: 50%; 
                            width: 40px; 
                            height: 40px; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                            box-shadow: 0 0 10px rgba(0,0,0,0.5);
                        ">
                            ${cluster.reports.length}
                        </div>
                    `,
                    className: 'empty'
                });

                L.marker([lat, lon], { icon: clusterIcon }).addTo(this.map);
            }
        }

        function refreshDashboard() {
            if (window.dashboard) {
                window.dashboard.loadDashboard();
            }
        }

        // 신고 상세보기 모달 관련 함수들
        async function showReportDetail(reportId) {
            const modal = document.getElementById('reportModal');
            const modalBody = document.getElementById('reportModalBody');
            
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading">신고 정보를 불러오는 중...</div>';
            
            try {
                const response = await fetch(`/api/report/${reportId}/detail`);
                const report = await response.json();
                
                displayReportDetail(report);
            } catch (error) {
                console.error('신고 상세 정보 로드 오류:', error);
                modalBody.innerHTML = '<div class="loading">신고 정보를 불러오는데 실패했습니다.</div>';
            }
        }

        function displayReportDetail(report) {
            const modalBody = document.getElementById('reportModalBody');
            
            const urgencyText = ['낮음', '보통', '높음', '매우높음', '긴급'][report.urgency_level - 1];
            const statusText = {
                '접수': '접수완료',
                '검토중': '검토중',
                '처리중': '처리중',
                '완료': '처리완료'
            }[report.status] || report.status;
            
            let html = '';
            
            // 기본 정보 섹션
            html += '<div class="detail-section">';
            html += '<h3>📋 기본 정보</h3>';
            html += '<div class="detail-row"><span class="detail-label">신고번호:</span><span class="detail-value">#' + report.id + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">사용자ID:</span><span class="detail-value">' + report.user_id + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">손상유형:</span><span class="detail-value">' + report.damage_type + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">긴급도:</span><span class="detail-value"><span class="urgency-badge urgency-' + report.urgency_level + '">' + urgencyText + '</span></span></div>';
            html += '<div class="detail-row"><span class="detail-label">상태:</span><span class="detail-value"><span class="status-badge status-' + report.status.toLowerCase() + '">' + statusText + '</span></span></div>';
            html += '<div class="detail-row"><span class="detail-label">접수일:</span><span class="detail-value">' + new Date(report.created_at).toLocaleString('ko-KR') + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">수정일:</span><span class="detail-value">' + new Date(report.updated_at).toLocaleString('ko-KR') + '</span></div>';
            html += '</div>';
            
            // 위치 정보 섹션
            if (report.location || (report.latitude && report.longitude)) {
                html += '<div class="detail-section">';
                html += '<h3>📍 위치 정보</h3>';
                if (report.location) {
                    html += '<div class="detail-row"><span class="detail-label">주소:</span><span class="detail-value">' + report.location + '</span></div>';
                }
                if (report.latitude && report.longitude) {
                    html += '<div class="detail-row"><span class="detail-label">좌표:</span><span class="detail-value">위도 ' + report.latitude.toFixed(6) + ', 경도 ' + report.longitude.toFixed(6) + '</span></div>';
                }
                html += '</div>';
            }
            
            // 담당 부서 정보 섹션
            html += '<div class="detail-section">';
            html += '<h3>🏢 담당 부서</h3>';
            html += '<div class="detail-row"><span class="detail-label">부서명:</span><span class="detail-value">' + report.department + '</span></div>';
            html += '<div class="detail-row"><span class="detail-label">연락처:</span><span class="detail-value">' + report.department_contact + '</span></div>';
            html += '</div>';
            
            // 설명 섹션
            if (report.description) {
                html += '<div class="detail-section">';
                html += '<h3>📝 상세 설명</h3>';
                html += '<div class="detail-value">' + report.description + '</div>';
                html += '</div>';
            }
            
            // 이미지 섹션
            if (report.image_path) {
                html += '<div class="detail-section">';
                html += '<h3>📸 첨부 이미지</h3>';
                html += '<img src="/uploads/' + report.image_path + '" alt="신고 이미지" class="image-preview">';
                html += '<div class="no-image" style="display:none;">이미지를 불러올 수 없습니다.</div>';
                html += '</div>';
            }
            
            // 액션 버튼들
            html += '<div class="action-buttons">';
            
            // 상태 변경 버튼들
            const statusButtons = {
                '접수': ['검토중', '완료'],
                '검토중': ['처리중', '완료'],
                '처리중': ['완료'],
                '완료': []
            };
            
            const availableStatuses = statusButtons[report.status] || [];
            availableStatuses.forEach(status => {
                const buttonClass = status === '완료' ? 'btn-success' : 
                                  status === '처리중' ? 'btn-warning' : 'btn-primary';
                html += '<button class="btn ' + buttonClass + '" data-action="update" data-report-id="' + report.id + '" data-status="' + status + '">' + status + '로 변경</button>';
            });
            
            html += '<button class="btn btn-danger" data-action="delete" data-report-id="' + report.id + '">신고 삭제</button>';
            html += '<button class="btn btn-secondary" data-action="close">닫기</button>';
            html += '</div>';
            
            modalBody.innerHTML = html;
            
            // 이벤트 리스너 추가
            modalBody.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn')) {
                    const action = e.target.getAttribute('data-action');
                    const reportId = e.target.getAttribute('data-report-id');
                    const status = e.target.getAttribute('data-status');
                    
                    if (action === 'update') {
                        updateReportStatus(reportId, status);
                    } else if (action === 'delete') {
                        deleteReport(reportId);
                    } else if (action === 'close') {
                        closeReportModal();
                    }
                }
            });
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        async function updateReportStatus(reportId, newStatus) {
            if (!confirm('신고 #' + reportId + '의 상태를 \'' + newStatus + '\'로 변경하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/report/' + reportId + '/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newStatus)
                });
                
                if (response.ok) {
                    alert('신고 상태가 성공적으로 변경되었습니다.');
                    closeReportModal();
                    refreshDashboard(); // 대시보드 새로고침
                } else {
                    const error = await response.json();
                    alert('상태 변경 실패: ' + error.detail);
                }
            } catch (error) {
                console.error('상태 변경 오류:', error);
                alert('상태 변경 중 오류가 발생했습니다.');
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('신고 #' + reportId + '를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/report/' + reportId, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('신고가 성공적으로 삭제되었습니다.');
                    closeReportModal();
                    refreshDashboard(); // 대시보드 새로고침
                } else {
                    const error = await response.json();
                    alert('삭제 실패: ' + error.detail);
                }
            } catch (error) {
                console.error('삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target === modal) {
                closeReportModal();
            }
        }

        // 대시보드 초기화
        window.dashboard = new Dashboard();
    </script>
</body>
</html>
